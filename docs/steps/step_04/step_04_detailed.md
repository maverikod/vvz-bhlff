# Step 04: Детализированное задание - Валидационные тесты уровня A

**Author:** Vasiliy Zdanovskiy  
**email:** vasilyvz@gmail.com

## Обзор

Данный документ представляет максимально детализированное техническое задание для реализации валидационных тестов уровня A (базовые решатели) в рамках проекта BHLFF - 7D phase field theory. Задание основано на техническом задании проекта, теоретических основах из документа 7d-00-18.md и базовом задании шага 04.

## Физический контекст

### Теоретическая основа

В рамках 7D phase field theory базовые решатели реализуют решение уравнения фракционного оператора Рисса:

$$\mathcal{L}_\beta a = \mu(-\Delta)^\beta a + \lambda a = s(x)$$

где:
- $a(x) \in \mathbb{C}$ - комплексное фазовое поле
- $\mu > 0$ - коэффициент диффузии
- $\beta \in (0,2)$ - фракционный порядок
- $\lambda \geq 0$ - параметр затухания
- $s(x)$ - источник возбуждения

### Спектральная форма решения

В k-пространстве решение имеет вид:
$$\widehat{a}(k) = \frac{\widehat{s}(k)}{\mu|k|^{2\beta} + \lambda}$$

где $k = \frac{2\pi}{L}m$, $m \in \mathbb{Z}^3$ - дискретные волновые числа.

## Детальные требования к тестам

### A0. Базовая валидация решателей

#### A0.1. Плоская волна (стационарный режим)

**Физический смысл:** Проверка корректности спектрального решения для простейшего случая монохроматического возбуждения.

**Математическая постановка:**
- Источник: $s(x) = e^{i k^* \cdot x}$ с $k^* = \frac{2\pi}{L}(p,q,r)$
- Аналитическое решение: $a(x) = \frac{s(x)}{D(k^*)}$ где $D(k) = \mu|k|^{2\beta} + \lambda$

**Параметры тестирования:**
```json
{
  "domain": {"L": 1.0, "N": [64, 128, 256]},
  "physics": {
    "mu": 1.0,
    "beta": [0.5, 1.0, 1.5],
    "lambda": [0.0, 1.0]
  },
  "forcing": {
    "type": "plane_wave",
    "modes": [[4,0,0], [0,4,0], [3,3,2], [2,2,4]]
  }
}
```

**Критерии приёмки:**
- Ошибка в $L^2$: $E_2 = \frac{\|a_{num} - a_{ref}\|_2}{\|a_{ref}\|_2} \leq 10^{-12}$
- Анизотропия: для всех направлений с одинаковым $|k^*|$ амплитуды совпадают с относительным отклонением $\leq 10^{-12}$
- Сходимость по сетке: при увеличении N в 2 раза ошибка должна уменьшаться

**Реализация:**
```python
def test_A01_plane_wave():
    """
    Test A0.1: Plane wave validation
    
    Physical Meaning:
        Validates the spectral solution for monochromatic excitation,
        ensuring correct implementation of the fractional Laplacian
        operator in k-space.
        
    Mathematical Foundation:
        Tests the formula a_hat(k) = s_hat(k) / D(k) where
        D(k) = mu|k|^(2*beta) + lambda is the spectral operator.
    """
    # Implementation details...
```

#### A0.2. Периодический многочастотный источник

**Физический смысл:** Проверка принципа суперпозиции и отсутствия алиасинга при многочастотном возбуждении.

**Математическая постановка:**
- Источник: $s(x) = \sum_{j=1}^J c_j e^{i k_j \cdot x}$ с $J=10$
- Случайные целочисленные $k_j$ в пределах Найквиста
- Амплитуды $c_j \in \mathbb{C}$ с единичной нормой

**Параметры тестирования:**
```json
{
  "domain": {"L": 1.0, "N": 256},
  "physics": {"mu": 1.0, "beta": 1.0, "lambda": 0.1},
  "forcing": {
    "type": "multi_plane",
    "modes": 10,
    "max_frequency": "nyquist",
    "seed": 42
  }
}
```

**Критерии приёмки:**
- Аналитическое решение: $\widehat{a}(k_j) = \frac{c_j}{D(k_j)}$, остальные моды нулевые
- Порог ошибки: $10^{-12}$
- Отсутствие алиасинга: проверка отсутствия ложных мод

#### A0.3. Случай "λ=0" и нулевая мода

**Физический смысл:** Проверка корректной обработки критического случая, когда оператор становится вырожденным.

**Математическая постановка:**
При $\lambda = 0$ оператор $\mathcal{L}_\beta$ имеет нулевое собственное значение для $k=0$, что требует специальной обработки.

**Тестовые случаи:**
1. $\lambda = 0$, $\widehat{s}(0) = 0$ - ожидается нормальная работа
2. $\lambda = 0$, $\widehat{s}(0) \neq 0$ - ожидается исключение с сообщением

**Критерии приёмки:**
- Корректное обнаружение условия $\widehat{s}(0) = 0$ при $\lambda = 0$
- Понятные сообщения об ошибках
- Правильные коды возврата

**Реализация:**
```python
def test_A03_zero_mode():
    """
    Test A0.3: Zero mode handling for lambda=0
    
    Physical Meaning:
        Validates proper handling of the critical case where the
        fractional Laplacian operator becomes singular at k=0
        when lambda=0.
        
    Mathematical Foundation:
        When lambda=0, the operator L_beta has zero eigenvalue
        at k=0, requiring special treatment to avoid division by zero.
    """
    # Test case 1: lambda=0, s_hat(0)=0 -> should work
    # Test case 2: lambda=0, s_hat(0)!=0 -> should raise exception
```

#### A0.4. Временной решатель: гармонический источник

**Физический смысл:** Проверка корректности временного интегратора для установившегося режима.

**Математическая постановка:**
$$\partial_t a + \nu(-\Delta)^\beta a + \lambda a = s_0 e^{i k^* \cdot x} e^{-i\omega t}$$

**Аналитическое решение (установившийся режим):**
$$a_{ss}(x,t) = \frac{s_0}{\nu|k^*|^{2\beta} + \lambda + i\omega} e^{i k^* \cdot x} e^{-i\omega t}$$

**Параметры тестирования:**
```json
{
  "domain": {"L": 1.0, "N": 128},
  "physics": {
    "nu": 1.0,
    "beta": [0.5, 1.0],
    "lambda": [0.0, 0.1]
  },
  "time": {
    "dt": 1e-3,
    "T": 10.0,
    "scheme": "exponential"
  },
  "forcing": {
    "type": "harmonic_in_time",
    "omega": [1.0, 10.0],
    "k_star": [4, 0, 0]
  }
}
```

**Критерии приёмки:**
- Относительная ошибка амплитуды: $\leq 10^{-8}$
- Относительная ошибка фазы: $\leq 10^{-8}$
- Время установления: $t_{ss} = \frac{10}{\nu|k^*|^{2\beta} + \lambda}$

#### A0.5. Энергетический баланс/невязка

**Физический смысл:** Подтверждение того, что численное решение действительно удовлетворяет исходному уравнению.

**Математическая постановка:**
- Невязка: $r = \mathcal{L}_\beta a - s$ (вычисляется через FFT)
- Энергетический баланс: проверка ортогональности невязки к решению

**Критерии приёмки:**
- $\frac{\|r\|_2}{\|s\|_2} \leq 10^{-12}$
- Ортогональность: $\Re\sum_m \overline{\widehat{a}(m)} \widehat{r}(m) \approx 0$ с допуском $\leq 10^{-12}\|\widehat{a}\|_2\|\widehat{r}\|_2$

### A1. Обезразмеривание/инвариантность

#### A1.1. Инвариантность к масштабу длины

**Физический смысл:** Проверка корректности обезразмеривания при изменении физического размера области.

**Математическая постановка:**
- Случай 1: $L=1$, $N=256$
- Случай 2: $L=2$, $N=512$ (тот же $\Delta = L/N$)
- Одинаковый безразмерный источник $\tilde{s}$

**Критерии приёмки:**
$$\frac{\|\tilde{a}^{(1)} - \tilde{a}^{(2)}\|_2}{\|\tilde{a}^{(1)}\|_2} \leq 10^{-12}$$

#### A1.2. Инвариантность к выбору базовых единиц

**Физический смысл:** Проверка корректности обезразмеривания при изменении системы единиц.

**Математическая постановка:**
- Разные $(L_0, T_0, A_0)$ - базовые единицы длины, времени, амплитуды
- Одинаковые безразмерные параметры $(\tilde{\nu}, \tilde{\lambda}, \tilde{s})$

**Критерии приёмки:**
Совпадение безразмерного решения $\tilde{a}$ в допуске $10^{-12}$

## Технические требования к реализации

### Язык и библиотеки
- **Язык:** Python 3.10+
- **Точность:** float64 (обязательно)
- **Библиотеки:** NumPy, SciPy, FFTW или эквивалент
- **FFT план:** "MEASURE" для оптимизации

### Соглашения FFT
- **Индексация:** $[-N/2, \ldots, N/2-1]$ по всем осям
- **Нормировка:** строго единая для всех тестов
- **Обработка отрицательных частот:** через смещение

### Обработка ошибок
- Проверка входных данных с понятными исключениями
- Специальная обработка случая $\lambda=0, \widehat{s}(0) \neq 0$
- Предотвращение переполнения при вычислении $|k|^{2\beta}$

## Структура файлов

### Основные модули
```
src/bhlff/core/
├── fft_solver.py          # Основной FFT решатель
├── frac_laplacian.py      # Фракционный оператор Рисса
├── time_integrators.py    # Временные интеграторы
└── spectral_ops.py        # Спектральные операции
```

### Тесты
```
tests/unit/test_level_a/
├── test_A01_plane_wave.py
├── test_A02_multi_plane.py
├── test_A03_zero_mode.py
├── test_A04_time_harmonic.py
├── test_A05_residual_energy.py
├── test_A11_scale_length.py
└── test_A12_units_invariance.py
```

### Конфигурации
```
configs/level_a/
├── A01_plane_wave.json
├── A02_multi_plane.json
├── A03_zero_mode.json
├── A04_time_harmonic.json
├── A05_residual_energy.json
├── A11_scale_length.json
└── A12_units_invariance.json
```

## Формат конфигурации

### Базовый шаблон
```json
{
  "test_id": "A01",
  "test_name": "plane_wave",
  "domain": {
    "L": 1.0,
    "N": 256,
    "dimensions": 3
  },
  "physics": {
    "mu": 1.0,
    "beta": 1.0,
    "lambda": 0.1,
    "nu": 1.0
  },
  "time": {
    "dt": 1e-3,
    "T": 1.0,
    "scheme": "exponential"
  },
  "forcing": {
    "type": "plane_wave",
    "modes": [[4,0,0]],
    "amplitudes": [[1.0, 0.0]],
    "omega": 0.0
  },
  "output": {
    "dir": "output/A01",
    "save_fields": true,
    "save_spectra": true,
    "save_analysis": true,
    "format": "hdf5"
  },
  "tolerance": {
    "error_L2": 1e-12,
    "anisotropy": 1e-12,
    "residual": 1e-12
  },
  "seed": 42
}
```

## Выходные данные

### 1. Поля и спектры
- `a_realspace.npy` - поле в реальном пространстве
- `a_kspace.npy` - поле в k-пространстве  
- `s_kspace.npy` - источник в k-пространстве
- `residual_k.npy` - невязка в k-пространстве

### 2. Метрики (JSON)
```json
{
  "test_id": "A01",
  "status": "PASS",
  "metrics": {
    "error_L2": 1.2e-13,
    "error_inf": 2.1e-13,
    "anisotropy": 3.4e-14,
    "residual_norm": 4.5e-13,
    "orthogonality": 5.6e-14
  },
  "parameters": {
    "domain": {"L": 1.0, "N": 256},
    "physics": {"mu": 1.0, "beta": 1.0, "lambda": 0.1}
  },
  "execution_time": 0.123,
  "memory_usage": 45.6
}
```

### 3. Логи (CSV)
```csv
test_id,status,error_L2,error_inf,anisotropy,residual_norm,execution_time,memory_usage
A01,PASS,1.2e-13,2.1e-13,3.4e-14,4.5e-13,0.123,45.6
A02,PASS,2.3e-13,3.4e-13,4.5e-14,5.6e-13,0.234,56.7
```

### 4. Визуализация
- Графики полей в реальном и k-пространстве
- Радиальные профили для анализа анизотропии
- Графики сходимости по сетке
- Временные ряды для динамических тестов

## Система отчетности

### Автоматическая генерация отчетов
- JSON отчеты для каждого теста
- Сводный HTML отчет со всеми результатами
- CSV логи для анализа трендов
- Автоматические графики и визуализация

### Критерии готовности
- [ ] Реализованы все тесты A0.1–A0.5
- [ ] Реализованы все тесты A1.1–A1.2  
- [ ] Все тесты проходят с требуемой точностью
- [ ] Система отчетности работает корректно
- [ ] Конфигурации тестов созданы
- [ ] Документация тестов написана
- [ ] Примеры использования созданы
- [ ] Автоматизация тестирования настроена

## Численные предосторожности

### Точность вычислений
- Использование float64 для всех вычислений
- Проверка переполнения при $|k|^{2\beta}$
- Корректная обработка моды $k=0$

### Временные интеграторы
- При явных схемах: $\Delta t \leq \frac{c}{\nu k_{max}^{2\beta} + \lambda}$
- Рекомендуется экспоненциальный шаг или Crank-Nicolson
- Проверка устойчивости схемы

### FFT нормировка
- Строго единая нормировка для всех тестов
- Корректная обработка отрицательных частот
- Проверка сохранения энергии

## Критерии приёмки (сводно)

| Тест | Критерий | Допуск |
|------|----------|--------|
| A0.1–A0.2 | Ошибка $L^2$ | $\leq 10^{-12}$ |
| A0.1–A0.2 | Анизотропия | $\leq 10^{-12}$ |
| A0.3 | Обработка $\lambda=0$ | Корректный FAIL/сообщение |
| A0.4 | Ошибка амплитуды/фазы | $\leq 10^{-8}$ |
| A0.5 | Невязка | $\leq 10^{-12}$ |
| A0.5 | Ортогональность | $\leq 10^{-12}$ |
| A1.1–A1.2 | Инвариантность | $\leq 10^{-12}$ |

**Все тесты должны проходить.** Любое отклонение от критериев - FAIL с подробным отчетом.

## Следующий шаг

После успешного выполнения Step 04 переходим к Step 05: Создание тестов фундаментальных свойств поля уровня B, включающих:
- Степенные хвосты решений
- Анализ топологических дефектов  
- Разделение зон "ядро-переход-хвост"
- Валидацию топологического заряда

## Заключение

Данное детализированное задание обеспечивает полную спецификацию для реализации валидационных тестов уровня A. Все требования основаны на строгих математических критериях и физических принципах 7D phase field theory. Успешное выполнение всех тестов подтвердит корректность базовых решателей и готовность к реализации более сложных моделей следующих уровней.
