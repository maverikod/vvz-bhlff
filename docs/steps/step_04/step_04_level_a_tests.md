# Step 04: Валидационные тесты уровня A (базовые решатели)

## Цель
Реализовать полный набор валидационных тестов для проверки корректности базовых решателей и численных алгоритмов.

## Структура тестов

### A0. Валидация решателей (стационарные/квазистационарные)

#### A0.1. ВБП-модуляция огибающей (стационар)
- **Цель**: Проверить базовую функциональность ВБП-решателя для огибающей
- **Постановка**: Периодический T³, уравнение огибающей ВБП ∇·(κ(|a|)∇a) + k₀²χ(|a|)a = s(x)
- **Наблюдаемое**: Сходимость огибающей по сетке (×2: N=128→256→512), отсутствие анизотропии
- **Критерии**: Энергобаланс ВБП ≤1–3%, относительная ошибка огибающей ≤10⁻¹²

#### A0.2. Многочастотные ВБП-модуляции (стационар)
- **Цель**: Проверить суперпозицию ВБП-модуляций и отсутствие алиасинга
- **Постановка**: s(x) = Σⱼ cⱼ modulating BVP envelope, J=10, случайные целочисленные kⱼ
- **Наблюдаемое**: Аналитическое решение огибающей â(kⱼ) = cⱼ/D_BVP(kⱼ)
- **Критерии**: Порог ошибки ВБП-модуляций 10⁻¹²

#### A0.3. Случай "λ=0" и нулевая мода
- **Цель**: Корректная обработка ŝ(0)
- **Постановка**: 
  - λ=0, ŝ(0)=0 (константа в источнике удалена) — ОЖИДАЕТСЯ нормальная работа
  - λ=0, ŝ(0)≠0 — ОЖИДАЕТСЯ отказ с ясным сообщением
- **Критерии**: Обнаружение условия, корректные коды возврата/ошибки

#### A0.4. Временной решатель: ВБП-модуляция, квенч-индуцированный источник
- **Цель**: Проверить ВБП-интегратор с квенчами
- **Постановка**: ∂ₜa + ∇·(κ(|a|)∇a) + k₀²χ(|a|)a = s₀(x) modulating BVP envelope
- **Наблюдаемое**: Установившийся режим огибающей с квенч-индуцированными потерями
- **Критерии**: Ошибка амплитуды и фазы огибающей ≤10⁻⁸, корректная детекция квенчей

#### A0.5. Энергетический баланс/невязка (стац.)
- **Цель**: Подтвердить решение как минимум функционала и уравнения
- **Постановка**: Невязка r = L_β a - s (через FFT)
- **Критерии**: ||r||₂/||s||₂ ≤ 10⁻¹², ортогональность невязки к решению

### A1. Обезразмеривание/инвариантность

#### A1.1. Инвариантность к масштабу длины
- **Цель**: Проверить корректный пересчёт при смене L
- **Постановка**: (i) L=1, N=256; (ii) L=2, N=512 (тот же Δ)
- **Критерии**: Безразмерные решения совпадают по норме ≤10⁻¹²

#### A1.2. Инвариантность к выбору базовых единиц
- **Цель**: Проверить обезразмеривание
- **Постановка**: Разные (L₀,T₀,A₀), но одинаковые (ν̃,λ̃,ṡ)
- **Критерии**: Совпадение ã в допуске 10⁻¹²

## Реализация тестов

### 1. Структура тестов (tests/test_level_a.py)
```python
class TestLevelA:
    def test_A01_bvp_envelope_modulation(self):
        """Тест A0.1: ВБП-модуляция огибающей"""
        
    def test_A02_multi_frequency_bvp_modulations(self):
        """Тест A0.2: Многочастотные ВБП-модуляции"""
        
    def test_A03_zero_mode(self):
        """Тест A0.3: Нулевая мода при λ=0"""
        
    def test_A04_time_bvp_quench_source(self):
        """Тест A0.4: Временной ВБП-источник с квенчами"""
        
    def test_A05_residual_energy(self):
        """Тест A0.5: Энергетический баланс"""
        
    def test_A11_scale_length(self):
        """Тест A1.1: Инвариантность к масштабу"""
        
    def test_A12_units_invariance(self):
        """Тест A1.2: Инвариантность к единицам"""
```

### 2. Конфигурации тестов (configs/level_a_tests.json)
```json
{
    "A01": {
        "domain": {"L": 1.0, "N": 256},
        "physics": {"mu": 1.0, "beta": 1.0, "lambda": 0.1},
        "forcing": {"type": "plane_wave", "k": [4, 0, 0]},
        "tolerance": 1e-12
    },
    "A02": {
        "domain": {"L": 1.0, "N": 256},
        "physics": {"mu": 1.0, "beta": 1.0, "lambda": 0.1},
        "forcing": {"type": "multi_plane", "modes": 10},
        "tolerance": 1e-12
    }
}
```

### 3. Система отчетности
- Автоматическая генерация отчетов
- Логирование всех тестов
- Экспорт результатов в JSON/CSV
- Визуализация ошибок и метрик

## Критерии приёмки

### Численные допуски
- A0.1–A0.2: E₂ ≤ 10⁻¹², анизотропия ≤ 10⁻¹²
- A0.3: Корректный FAIL/сообщение при нарушении ŝ(0)=0 при λ=0
- A0.4: Ошибка амплитуды и фазы ≤ 10⁻⁸
- A0.5: ||r||₂/||s||₂ ≤ 10⁻¹², ортогональность в допуске
- A1.1–A1.2: Инвариантность ≤ 10⁻¹²

### Требования к реализации
- Язык: Python 3.10+, float64
- Библиотеки: NumPy/SciPy/FFTW
- Единые соглашения FFT
- Обработка индексов k: отрицательные частоты через смещение [-N/2, N/2)
- Проверка входных данных с понятными исключениями

## Выходные данные

### 1. Поля/спектры
- a_realspace.npy - поле в реальном пространстве
- a_kspace.npy - поле в k-пространстве
- s_kspace.npy - источник в k-пространстве

### 2. Диагностика
- residual_k.npy - невязка в k-пространстве
- residual_norms.json - нормы невязки

### 3. Метрики (JSON)
- Ошибки E₂, E_∞
- Анизотропия
- Невязка
- Успешность тестов

### 4. Логи (CSV)
- Строка на тест с параметрами и verdict ∈ {PASS, FAIL}

## Конкретные критерии точности

### 1. Критерии точности для тестов A0.1-A0.5
```python
ACCURACY_CRITERIA = {
    "A0.1_plane_wave": {
        "relative_error": 1e-12,      # Относительная ошибка решения
        "residual_norm": 1e-14,       # Норма невязки
        "energy_conservation": 1e-15, # Сохранение энергии
        "anisotropy": 1e-12           # Анизотропия
    },
    "A0.2_multi_frequency": {
        "relative_error": 1e-11,      # Относительная ошибка
        "residual_norm": 1e-13,       # Норма невязки
        "frequency_accuracy": 1e-10,  # Точность частот
        "amplitude_accuracy": 1e-9    # Точность амплитуд
    },
    "A0.3_zero_mode": {
        "relative_error": 1e-12,      # Относительная ошибка
        "residual_norm": 1e-14,       # Норма невязки
        "zero_mode_handling": 1e-15,  # Обработка k=0 моды
        "lambda_zero_accuracy": 1e-12 # Точность при λ=0
    },
    "A0.4_time_dependent": {
        "relative_error": 1e-10,      # Относительная ошибка
        "residual_norm": 1e-12,       # Норма невязки
        "temporal_accuracy": 1e-9,    # Временная точность
        "energy_balance": 0.03        # Энергетический баланс
    },
    "A0.5_energy_balance": {
        "energy_conservation": 1e-15, # Сохранение энергии
        "energy_balance": 0.03,       # Энергетический баланс
        "residual_norm": 1e-14,       # Норма невязки
        "orthogonality": 1e-12        # Ортогональность
    }
}
```

### 2. Критерии точности для тестов A1.1-A1.2
```python
INVARIANCE_CRITERIA = {
    "A1.1_length_scale": {
        "scale_invariance": 1e-10,    # Инвариантность масштаба
        "relative_error": 1e-9,       # Относительная ошибка
        "profile_consistency": 1e-8,  # Консистентность профилей
        "spectral_consistency": 1e-9  # Спектральная консистентность
    },
    "A1.2_unit_invariance": {
        "unit_invariance": 1e-10,     # Инвариантность единиц
        "relative_error": 1e-9,       # Относительная ошибка
        "dimensionless_consistency": 1e-8, # Консистентность безразмерных величин
        "parameter_scaling": 1e-9     # Масштабирование параметров
    }
}
```

### 3. Критерии сходимости
```python
CONVERGENCE_CRITERIA = {
    "grid_convergence": {
        "min_order": 2.0,             # Минимальный порядок сходимости
        "target_order": 3.0,          # Целевой порядок сходимости
        "convergence_tolerance": 0.1, # Допуск для порядка сходимости
        "error_reduction": 0.5        # Минимальное уменьшение ошибки
    },
    "time_convergence": {
        "min_order": 1.0,             # Минимальный порядок временной сходимости
        "target_order": 2.0,          # Целевой порядок временной сходимости
        "convergence_tolerance": 0.2, # Допуск для временной сходимости
        "stability_factor": 0.8       # Фактор устойчивости
    }
}
```

### 4. Критерии производительности
```python
PERFORMANCE_CRITERIA = {
    "execution_time": {
        "N64_max_time": 0.1,          # Максимальное время для N=64 (сек)
        "N128_max_time": 0.5,         # Максимальное время для N=128 (сек)
        "N256_max_time": 2.0,         # Максимальное время для N=256 (сек)
        "scaling_factor": 8.0         # Фактор масштабирования времени
    },
    "memory_usage": {
        "N64_max_memory": 0.1,        # Максимальная память для N=64 (ГБ)
        "N128_max_memory": 0.5,       # Максимальная память для N=128 (ГБ)
        "N256_max_memory": 2.0,       # Максимальная память для N=256 (ГБ)
        "memory_scaling": 8.0         # Масштабирование памяти
    }
}
```

### 5. Критерии качества
```python
QUALITY_CRITERIA = {
    "numerical_stability": {
        "condition_number": 1e12,     # Максимальное число обусловленности
        "eigenvalue_stability": 1e-6, # Стабильность собственных значений
        "rounding_error": 1e-15       # Ошибка округления
    },
    "physical_validity": {
        "energy_conservation": 1e-15, # Сохранение энергии
        "momentum_conservation": 1e-12, # Сохранение импульса
        "causality": 1e-10,           # Причинность
        "locality": 1e-8              # Локальность
    }
}
```

## Критерии готовности
- [ ] Реализованы все тесты A0.1–A0.5 с конкретными критериями точности
- [ ] Реализованы все тесты A1.1–A1.2 с критериями инвариантности
- [ ] Все тесты проходят с требуемой точностью согласно критериям
- [ ] Критерии сходимости проверены и валидированы
- [ ] Критерии производительности соответствуют требованиям
- [ ] Критерии качества обеспечивают физическую валидность
- [ ] Система отчетности работает корректно
- [ ] Конфигурации тестов созданы
- [ ] Документация тестов написана
- [ ] Примеры использования созданы
- [ ] Автоматизация тестирования настроена

## Следующий шаг
Step 05: Создание тестов фундаментальных свойств поля уровня B
